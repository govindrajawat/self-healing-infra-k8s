apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
data:
  prometheus.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      url: http://prometheus:9090
      access: proxy
      isDefault: true
---
# This ConfigMap tells Grafana WHERE to look for dashboard JSON files
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: monitoring
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: default
      orgId: 1
      folder: Self-Healing
      type: file
      options:
        path: /var/lib/grafana/dashboards
---
# Dashboard JSON - uses only metrics from the Node.js app
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
data:
  self-healing.json: |
    {
      "title": "Self-Healing Overview",
      "tags": ["self-healing"],
      "timezone": "browser",
      "refresh": "10s",
      "time": { "from": "now-1h", "to": "now" },
      "panels": [
        {
          "id": 1,
          "title": "App Up / Down",
          "type": "stat",
          "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
          "targets": [
            { "expr": "up{job=\"nodejs-app\"}", "legendFormat": "nodejs-app" }
          ],
          "fieldConfig": {
            "defaults": {
              "mappings": [
                { "type": "value", "options": { "0": { "text": "DOWN", "color": "red" }, "1": { "text": "UP", "color": "green" } } }
              ]
            }
          }
        },
        {
          "id": 2,
          "title": "Heap Memory Usage (bytes)",
          "type": "timeseries",
          "gridPos": { "x": 0, "y": 4, "w": 12, "h": 8 },
          "targets": [
            { "expr": "app_memory_usage_bytes{job=\"nodejs-app\"}", "legendFormat": "heap used" }
          ]
        },
        {
          "id": 3,
          "title": "HTTP Request Rate",
          "type": "timeseries",
          "gridPos": { "x": 12, "y": 4, "w": 12, "h": 8 },
          "targets": [
            { "expr": "rate(http_requests_total{job=\"nodejs-app\"}[1m])", "legendFormat": "{{method}} {{route}} {{status}}" }
          ]
        },
        {
          "id": 4,
          "title": "5xx Error Rate",
          "type": "timeseries",
          "gridPos": { "x": 0, "y": 12, "w": 12, "h": 8 },
          "targets": [
            { "expr": "rate(http_requests_total{job=\"nodejs-app\", status=~\"5..\"}[1m])", "legendFormat": "errors/s" }
          ]
        },
        {
          "id": 5,
          "title": "CPU Usage",
          "type": "timeseries",
          "gridPos": { "x": 12, "y": 12, "w": 12, "h": 8 },
          "targets": [
            { "expr": "rate(process_cpu_seconds_total{job=\"nodejs-app\"}[1m]) * 100", "legendFormat": "cpu %" }
          ]
        }
      ]
    }